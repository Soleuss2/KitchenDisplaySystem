@model IEnumerable<SelfOrderingSystemKiosk.Models.InventoryItem>
@{
    Layout = "~/Areas/Customer/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Unlimited Menu";
}

<link rel="stylesheet" href="~/css/kiosk.css" />
<link rel="stylesheet" href="~/css/Menu.css" />
@await Html.PartialAsync("_Loader")
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<div class="container">
    <!-- Back Button -->
    <form asp-action="ChooseExperience" method="get" style="position:absolute;top:30px;left:40px;">
        <button type="submit" class="back-btn" title="Back to Experience Selection">
            <i class="bi bi-arrow-left-circle-fill" style="font-size: 2rem;"></i>
        </button>
    </form>

    <div class="menu-container">
        <!-- LEFT: MENU LIST -->
        <div class="menu-list">
            <div class="menu-header">
                <h1>CHICKEN WINGS MENU</h1>
                <p>Endless Wings — ₱377 per head</p>
                @if (ViewBag.TableNumber != null)
                {
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin: 15px 0;">
                        <div style="background: #fff3e6; border: 2px solid #e67e22; border-radius: 10px; padding: 10px 15px; display: inline-block;">
                            <i class="bi bi-table" style="color: #d35400; margin-right: 5px;"></i>
                            <strong style="color: #d35400;">Table @ViewBag.TableNumber</strong>
                        </div>
                        <div id="table-timer" style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 10px 15px; display: none;">
                            <i class="bi bi-clock" style="color: #2e7d32; margin-right: 5px;"></i>
                            <strong style="color: #2e7d32;">Time Remaining: <span id="timer-display">--:--</span></strong>
                        </div>
                        <div id="table-timer-expired" style="background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 10px 15px; display: none;">
                            <i class="bi bi-exclamation-triangle" style="color: #c62828; margin-right: 5px;"></i>
                            <strong style="color: #c62828;">Session Expired - Please contact staff</strong>
                        </div>
                    </div>
                }
                <h2 style="margin-top:20px;">UNLIMITED MENU</h2>
                <p>Choose from our delicious selection of flavorful chicken wings</p>
            </div>

            <!-- Tabs -->
            <div class="menu-tabs">
                <button class="active" data-filter="all"><i class="bi bi-grid-1x2-fill"></i> All Items</button>
                <button data-filter="Wings"><img src="~/images/wings.png" alt="Wings Icon" /> Wings</button>
                <button data-filter="Appetizer"><img src="~/images/appetize.png" alt="Appetizer Icon" /> Appetizer</button>
                <button data-filter="Add Ons"><i class="bi bi-basket"></i> Add-Ons</button>
            </div>

            <!-- Scrollable Menu Items -->
            <div class="menu-scroll">
                @foreach (var item in Model)
                {
                    <div class="menu-row" data-category="@item.Category">
                        <img src="@Url.Content(item.Image ?? "/images/wings.png")" alt="@item.Item" />
                        <div class="menu-details">
                            <h4>@item.Item.ToUpper()</h4>
                        </div>
                        <button class="add-to-cart"
                                data-name="@item.Item"
                                data-price="377"
                                data-image="@Url.Content(item.Image ?? "/images/wings.png")">
                            Add to cart
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- RIGHT: ORDER SUMMARY -->
        <div class="order-summary">
            <div class="summary-header">
                <h3>Order Summary</h3>
                <p class="item-count">0 Items</p>
                <p class="person-count">0 Person(s)</p>
            </div>

            <div class="summary-list">
                <div class="empty-cart">
                    <i class="bi bi-cart-x-fill" style="font-size: 3rem;"></i>
                    <p>Your cart is empty<br>Add items from the menu to get started</p>
                </div>
            </div>

            <div class="summary-footer">
                <div class="order-breakdown">
                    <div class="breakdown-row">
                        <span>Per Person (₱377 × <span id="person-count-display">0</span>):</span>
                        <span id="per-person-subtotal">₱0.00</span>
                    </div>
                    <div class="breakdown-row subtotal-row">
                        <span><strong>Subtotal:</strong></span>
                        <span id="subtotal-amount"><strong>₱0.00</strong></span>
                    </div>
                    <div class="breakdown-row">
                        <span>Tax (12%):</span>
                        <span id="tax-amount">₱0.00</span>
                    </div>
                    <div class="breakdown-row total-row">
                        <span><strong>TOTAL:</strong></span>
                        <span class="order-total"><strong>₱0.00</strong></span>
                    </div>
                </div>
                <button class="confirm-btn">CONFIRM ORDER</button>
            </div>
        </div>
    </div>
</div>

<div id="notificationContainer" style="
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
"></div>

@await Html.PartialAsync("~/Areas/Customer/Views/Shared/Modals/_PersonModal.cshtml")
@await Html.PartialAsync("~/Areas/Customer/Views/Shared/Modals/_RulesModal.cshtml")
<script src="~/js/booking_cart.js"></script>

<script>
    // Category filter functionality
    document.querySelectorAll('.menu-tabs button').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.menu-tabs button').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get filter value
            const filter = this.getAttribute('data-filter');
            const menuRows = document.querySelectorAll('.menu-row');
            
            // Filter menu items
            menuRows.forEach(row => {
                if (filter === 'all') {
                    row.style.display = '';
                } else {
                    const category = row.getAttribute('data-category');
                    if (category === filter) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });
    });

    // Confirm Order
    document.querySelector('.confirm-btn').addEventListener('click', function() {
        if(cart.length === 0){
            alert("Your cart is empty!");
            return;
        }

        if(personCount === 0){
            alert("Please enter the number of persons first!");
            openModal("personModal");
            return;
        }

        // Prepare order items
        let orderItems = cart.map(c => ({
            ItemName: c.name,
            Quantity: c.quantity,
            Price: 0 // Unlimited items are included, no individual price
        }));

        // Send personCount as query parameter for unlimited orders
        fetch(`/Customer/Kiosk/ConfirmOrder?orderType=Unlimited&personCount=${personCount}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(orderItems)
    })
        .then(async res => {
            if (!res.ok) {
                const errorText = await res.text();
                console.error('Server error:', errorText);
                alert('Error creating order. Please try again.');
                return;
            }
            return res.json();
        })
        .then(data => {
            if(data && data.success){
                // Redirect to order tracking page
                window.location.href = '/Customer/Kiosk/Confirmation?orderNumber=' + data.orderNumber;
            } else {
                alert(data?.message || 'Error creating order. Please try again.');
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('Error creating order. Please try again.');
        });
    });

    // Table session timer
    @if (ViewBag.TableNumber != null)
    {
        <text>
        (function() {
            const tableNumber = '@ViewBag.TableNumber';
            let timerInterval = null;

            function updateTimer() {
                fetch(`/Customer/Kiosk/GetTableSessionInfo?tableNumber=${tableNumber}`)
                    .then(response => response.json())
                    .then(data => {
                        const timerDisplay = document.getElementById('timer-display');
                        const timerContainer = document.getElementById('table-timer');
                        const expiredContainer = document.getElementById('table-timer-expired');

                        if (data.hasSession) {
                            // For Unlimited menu, check for the submit button (might be different)
                            const submitBtn = document.querySelector('button[type="submit"]') || 
                                            document.querySelector('.confirm-btn') ||
                                            document.querySelector('.btn-primary');
                            
                            if (data.isExpired) {
                                timerContainer.style.display = 'none';
                                expiredContainer.style.display = 'block';
                                if (submitBtn) {
                                    submitBtn.disabled = true;
                                    submitBtn.style.opacity = '0.5';
                                    submitBtn.style.cursor = 'not-allowed';
                                    submitBtn.title = 'Session expired. Please contact staff.';
                                }
                                if (timerInterval) {
                                    clearInterval(timerInterval);
                                }
                            } else {
                                timerContainer.style.display = 'block';
                                expiredContainer.style.display = 'none';
                                
                                const minutes = Math.floor(data.timeRemainingSeconds / 60);
                                const seconds = data.timeRemainingSeconds % 60;
                                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                                
                                // Change color when less than 10 minutes remaining
                                if (data.timeRemainingSeconds < 600) {
                                    timerContainer.style.background = '#fff3e0';
                                    timerContainer.style.borderColor = '#ff9800';
                                    timerDisplay.style.color = '#e65100';
                                }
                                
                                // Enable order button if it was disabled
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.style.opacity = '1';
                                    submitBtn.style.cursor = 'pointer';
                                    submitBtn.title = '';
                                }
                            }
                        } else {
                            timerContainer.style.display = 'none';
                            expiredContainer.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching table session info:', error);
                    });
            }

            // Update timer immediately and then every second
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        })();
        </text>
    }
</script>

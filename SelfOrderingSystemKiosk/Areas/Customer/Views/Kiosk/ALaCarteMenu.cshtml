@model IEnumerable<SelfOrderingSystemKiosk.Models.InventoryItem>
@{
    ViewData["Title"] = "Ala Carte Menu";
    Layout = "~/Areas/Customer/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/kiosk.css" />
<link rel="stylesheet" href="~/css/Menu.css" />
@await Html.PartialAsync("_Loader")
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<div class="container">
    <!-- 🔙 Back Button -->
    <form asp-action="ChooseExperience" method="get" style="position:absolute;top:30px;left:40px;">
        <button type="submit" class="back-btn" title="Back to Experience Selection">
            <i class="bi bi-arrow-left-circle-fill" style="font-size: 2rem;"></i>
        </button>
    </form>

    <div class="menu-container">
        <!-- LEFT: MENU LIST -->
        <div class="menu-list">
            <div class="menu-header">
                <h1>CHICKEN WINGS MENU</h1>
                <p>Order your favorite dishes with ease</p>
                <h2 style="margin-top:20px;">ALA CARTE MENU</h2>
                <p>Pick and enjoy our flavorful chicken wings and special sides</p>
                <div id="session-timer" style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 10px; padding: 10px 15px; margin: 15px auto; display: none; max-width: 300px;">
                    <i class="bi bi-clock" style="color: #2e7d32; margin-right: 5px;"></i>
                    <strong style="color: #2e7d32;">Time Remaining: <span id="timer-display">--:--</span></strong>
                </div>
                <div id="session-timer-expired" style="background: #ffebee; border: 2px solid #f44336; border-radius: 10px; padding: 10px 15px; margin: 15px auto; display: none; max-width: 300px;">
                    <i class="bi bi-exclamation-triangle" style="color: #c62828; margin-right: 5px;"></i>
                    <strong style="color: #c62828;">Session Expired - Please start a new order</strong>
                </div>
            </div>

            <!-- Tabs -->
            <div class="menu-tabs">
                <button class="active" data-filter="all"><i class="bi bi-grid-1x2-fill"></i> All Items</button>
                <button data-filter="Wings"><img src="~/images/wings.png" alt="Wings Icon" /> Wings</button>
                <button data-filter="Appetizer"><img src="~/images/appetize.png" alt="Appetizer Icon" /> Appetizer</button>
                <button data-filter="Add Ons"><i class="bi bi-basket"></i> Add-Ons</button>
            </div>

            <!-- Scrollable Menu Items -->
            <div class="menu-scroll">
                @foreach (var item in Model)
                {
                    <div class="menu-row" data-category="@item.Category">
                        <img src="@Url.Content(item.Image ?? "/images/wings.png")" alt="@item.Item" />
                        <div class="menu-details">
                            <h4>@item.Item.ToUpper()</h4>
                            <p>₱@item.Price.ToString("0.00")</p>
                        </div>
                        <button class="add-to-cart"
                                data-name="@item.Item"
                                data-price="@item.Price"
                                data-image="@Url.Content(item.Image)">
                            Add to cart
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- RIGHT: ORDER SUMMARY -->
        <div class="order-summary">
            <div class="summary-header">
                <h3>Order Summary</h3>
                <p class="item-count">0 Items</p>
            </div>

            <div class="summary-list">
                <div class="empty-cart">
                    <i class="bi bi-cart-x-fill" style="font-size: 3rem;"></i>
                    <p>Your cart is empty<br>Add items from the menu to get started</p>
                </div>
            </div>

            <div class="summary-footer">
                <p class="order-total">TOTAL: ₱0.00</p>
                <button class="confirm-btn">CONFIRM ORDER</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Cart array to store items
    let cart = [];

    // Category filter functionality
    document.querySelectorAll('.menu-tabs button').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.menu-tabs button').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get filter value
            const filter = this.getAttribute('data-filter');
            const menuRows = document.querySelectorAll('.menu-row');
            
            // Filter menu items
            menuRows.forEach(row => {
                if (filter === 'all') {
                    row.style.display = '';
                } else {
                    const category = row.getAttribute('data-category');
                    if (category === filter) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });
    });

    // Add to cart functionality
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function (e) {
            e.preventDefault();

            const name = this.getAttribute('data-name');
            const price = parseFloat(this.getAttribute('data-price'));
            const image = this.getAttribute('data-image');

            // Check if item already exists in cart
            const existingItem = cart.find(item => item.name === name);

            if (existingItem) {
                // Limit quantity to 5 per item for ala carte
                if (existingItem.quantity >= 5) {
                    alert(`Maximum quantity of 5 per item allowed. You already have ${existingItem.quantity} of ${name} in your cart.`);
                    return;
                }
                existingItem.quantity += 1;
            } else {
                cart.push({
                    name: name,
                    price: price,
                    image: image,
                    quantity: 1
                });
            }

            updateCartDisplay();

            // Visual feedback
            this.textContent = 'Added!';
            this.style.backgroundColor = '#28a745';
            setTimeout(() => {
                this.textContent = 'Add to cart';
                this.style.backgroundColor = '';
            }, 500);
        });
    });

    // Update cart display
    function updateCartDisplay() {
        const summaryList = document.querySelector('.summary-list');
        const itemCount = document.querySelector('.item-count');
        const orderTotal = document.querySelector('.order-total');

        summaryList.innerHTML = '';

        if (cart.length === 0) {
            summaryList.innerHTML = `
                <div class="empty-cart">
                    <i class="bi bi-cart-x-fill" style="font-size: 3rem;"></i>
                    <p>Your cart is empty<br>Add items from the menu to get started</p>
                </div>
            `;
            itemCount.textContent = '0 Items';
            orderTotal.textContent = 'TOTAL: ₱0.00';
            return;
        }

        cart.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'cart-item';
            const isMaxQuantity = item.quantity >= 5;
            const plusButtonDisabled = isMaxQuantity ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : '';
            const maxQuantityIndicator = isMaxQuantity ? '<small style="color:#e74c3c;font-size:0.75em;display:block;">Max: 5</small>' : '';
            itemDiv.innerHTML = `
                <img src="${item.image}" alt="${item.name}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;">
                <div style="flex:1;margin-left:10px;">
                    <h5 style="margin:0;font-size:14px;">${item.name}</h5>
                    <p style="margin:0;color:#666;">₱${item.price.toFixed(2)}</p>
                    ${maxQuantityIndicator}
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <button class="qty-btn minus" data-index="${index}">-</button>
                    <span class="qty">${item.quantity}</span>
                    <button class="qty-btn plus" data-index="${index}" ${plusButtonDisabled}>+</button>
                    <button class="remove-btn" data-index="${index}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            summaryList.appendChild(itemDiv);
        });

        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        itemCount.textContent = `${totalItems} Item${totalItems !== 1 ? 's' : ''}`;
        orderTotal.textContent = `TOTAL: ₱${totalPrice.toFixed(2)}`;

        addCartEventListeners();
    }

    // Add event listeners for cart buttons
    function addCartEventListeners() {
        document.querySelectorAll('.qty-btn.plus').forEach(btn => {
            btn.addEventListener('click', function() {
                // Don't process if button is disabled
                if (this.disabled) {
                    return;
                }
                const index = parseInt(this.getAttribute('data-index'));
                // Limit quantity to 5 per item for ala carte
                if (cart[index].quantity >= 5) {
                    alert(`Maximum quantity of 5 per item allowed. You already have ${cart[index].quantity} of ${cart[index].name} in your cart.`);
                    return;
                }
                cart[index].quantity += 1;
                updateCartDisplay();
            });
        });

        document.querySelectorAll('.qty-btn.minus').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                if (cart[index].quantity > 1) {
                    cart[index].quantity -= 1;
                } else {
                    cart.splice(index, 1);
                }
                updateCartDisplay();
            });
        });

        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                cart.splice(index, 1);
                updateCartDisplay();
            });
        });
    }

    // Confirm order button
           document.querySelector('.confirm-btn').addEventListener('click', function () {
        // Check if session is expired (client-side check)
        const expiredContainer = document.getElementById('session-timer-expired');
        if (expiredContainer && expiredContainer.style.display !== 'none') {
            alert('Your 1-hour session has expired. Please start a new order.');
            return;
        }

        if (cart.length === 0) {
            alert('Please add items to your cart first!');
            return;
        }

        // Validate quantities before submitting (max 5 per item for ala carte)
        const invalidItems = cart.filter(item => item.quantity > 5);
        if (invalidItems.length > 0) {
            alert('Some items exceed the maximum quantity of 5 per item. Please adjust your order.');
            return;
        }

        const orderItems = cart.map(item => ({
            itemName: item.name,
            price: item.price,
            quantity: item.quantity
        }));

        document.querySelector('.loader-overlay').style.display = 'flex';

        fetch('/Customer/Kiosk/ConfirmOrder?orderType=AlaCarte', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderItems)
        })
        .then(response => response.json())
        .then(data => {
            document.querySelector('.loader-overlay').style.display = 'none';

            if (data.success) {
                window.location.href = `/Customer/Kiosk/Confirmation?orderNumber=${data.orderNumber}`;
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            document.querySelector('.loader-overlay').style.display = 'none';
            alert('Error: ' + error);
        });

    });

    // Session timer
    (function() {
        let timerInterval = null;

        function updateTimer() {
            fetch('/Customer/Kiosk/GetSessionInfo')
                .then(response => response.json())
                .then(data => {
                    const timerDisplay = document.getElementById('timer-display');
                    const timerContainer = document.getElementById('session-timer');
                    const expiredContainer = document.getElementById('session-timer-expired');

                    if (data.hasSession) {
                        const confirmBtn = document.querySelector('.confirm-btn');
                        if (data.isExpired) {
                            timerContainer.style.display = 'none';
                            expiredContainer.style.display = 'block';
                            if (confirmBtn) {
                                confirmBtn.disabled = true;
                                confirmBtn.style.opacity = '0.5';
                                confirmBtn.style.cursor = 'not-allowed';
                                confirmBtn.title = 'Session expired. Please start a new order.';
                            }
                            if (timerInterval) {
                                clearInterval(timerInterval);
                            }
                        } else {
                            timerContainer.style.display = 'block';
                            expiredContainer.style.display = 'none';
                            
                            const minutes = Math.floor(data.timeRemainingSeconds / 60);
                            const seconds = data.timeRemainingSeconds % 60;
                            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            // Change color when less than 10 minutes remaining
                            if (data.timeRemainingSeconds < 600) {
                                timerContainer.style.background = '#fff3e0';
                                timerContainer.style.borderColor = '#ff9800';
                                timerDisplay.style.color = '#e65100';
                            }
                            
                            // Enable order button if it was disabled
                            if (confirmBtn) {
                                confirmBtn.disabled = false;
                                confirmBtn.style.opacity = '1';
                                confirmBtn.style.cursor = 'pointer';
                                confirmBtn.title = '';
                            }
                        }
                    } else {
                        timerContainer.style.display = 'none';
                        expiredContainer.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching session info:', error);
                });
        }

        // Update timer immediately and then every second
        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
    })();

</script>

@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    var labelsJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.Labels);
    var valuesJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.Values);
    var todayRevenue = ViewBag.TodaysRevenue != null ? (decimal)ViewBag.TodaysRevenue : 0m;
    var todayRevenueDineIn = ViewBag.TodaysRevenueDineIn != null ? (decimal)ViewBag.TodaysRevenueDineIn : 0m;
    var todayRevenueTakeOut = ViewBag.TodaysRevenueTakeOut != null ? (decimal)ViewBag.TodaysRevenueTakeOut : 0m;
    var lowStockItemsList = ViewBag.LowStockList as List<SelfOrderingSystemKiosk.Models.InventoryItem> ?? new List<SelfOrderingSystemKiosk.Models.InventoryItem>();
    var bestSellersAll = ViewBag.BestSellersAllTime as List<SelfOrderingSystemKiosk.Controllers.BestSeller> ?? new List<SelfOrderingSystemKiosk.Controllers.BestSeller>();
    var bestSellersToday = ViewBag.BestSellersToday as List<SelfOrderingSystemKiosk.Controllers.BestSeller> ?? new List<SelfOrderingSystemKiosk.Controllers.BestSeller>();
    var todayRevenueAlaCarte = ViewBag.TodaysRevenueAlaCarte != null ? (decimal)ViewBag.TodaysRevenueAlaCarte : 0m;
    var todayRevenueUnlimited = ViewBag.TodaysRevenueUnlimited != null ? (decimal)ViewBag.TodaysRevenueUnlimited : 0m;
    var rangeStart = ViewBag.RangeStart != null ? ((DateTime)ViewBag.RangeStart).ToLocalTime() : DateTime.UtcNow.ToLocalTime().Date;
    var rangeEnd = ViewBag.RangeEnd != null ? ((DateTime)ViewBag.RangeEnd).ToLocalTime() : DateTime.UtcNow.ToLocalTime().Date;
    var rangeRevenue = ViewBag.RangeRevenue != null ? (decimal)ViewBag.RangeRevenue : 0m;
    var rangeRevenueAlaCarte = ViewBag.RangeRevenueAlaCarte != null ? (decimal)ViewBag.RangeRevenueAlaCarte : 0m;
    var rangeRevenueUnlimited = ViewBag.RangeRevenueUnlimited != null ? (decimal)ViewBag.RangeRevenueUnlimited : 0m;
    var rangeRevenueDineIn = ViewBag.RangeRevenueDineIn != null ? (decimal)ViewBag.RangeRevenueDineIn : 0m;
    var rangeRevenueTakeOut = ViewBag.RangeRevenueTakeOut != null ? (decimal)ViewBag.RangeRevenueTakeOut : 0m;
    var rangeOrderCount = ViewBag.RangeOrderCount != null ? (int)ViewBag.RangeOrderCount : 0;
}

<div class="dashboard-container">
    <h1>Admin Dashboard</h1>
    <p>Overview of key statistics</p>

    <!-- Stat Cards -->
    <div class="dashboard-cards">
        <div class="stat-card">
            <h3>Menu Items</h3>
            <div class="stat-value">@ViewBag.TotalMenuItems</div>
        </div>
        <div class="stat-card">
            <h3>Inventory Items</h3>
            <div class="stat-value">@ViewBag.TotalInventoryItems</div>
        </div>
        <div class="stat-card highlight-card clickable-card" role="button" tabindex="0" onclick="showLowStockModal()" onkeypress="if(event.key === 'Enter' || event.key === ' ') { showLowStockModal(); }">
            <h3>Low Stock Items</h3>
            <div class="stat-value">@ViewBag.LowStockItems</div>
        </div>
        <div class="stat-card">
            <h3>Today's Sales</h3>
            <div class="stat-value">@ViewBag.TodaysSales</div>
            <div class="stat-revenue" style="color: #27ae60; font-size: 0.9em; margin-top: 5px; font-weight: 600;">
                Total Revenue: ₱@todayRevenue.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #e67e22; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Ala Carte: ₱@todayRevenueAlaCarte.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #9b59b6; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Unlimited: ₱@todayRevenueUnlimited.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #3498db; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Dine In: ₱@todayRevenueDineIn.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #e74c3c; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Take Out: ₱@todayRevenueTakeOut.ToString("N2")
            </div>
        </div>
        <div class="stat-card highlight-card clickable-card" role="button" tabindex="0" onclick="showBestSellersModal()" onkeypress="if(event.key === 'Enter' || event.key === ' ') { showBestSellersModal(); }">
            <h3><i class="bi bi-trophy"></i> Best Sellers</h3>
            <div class="stat-value" style="font-size: 1.2em;">Top 5</div>
            <div style="color: #666; font-size: 0.85em; margin-top: 5px;">Click to view details</div>
        </div>
    </div>

    <!-- Sales Summary with Filters -->
    <div class="sales-summary-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px; margin-bottom: 20px;">
            <h2 style="color: #e67e22; margin: 0; display: flex; align-items: center; gap: 10px;"><i class="bi bi-graph-up"></i> <span>Sales Summary</span></h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="sales-filter-btn active" data-filter="week" onclick="filterSales('week')">Week</button>
                <button class="sales-filter-btn" data-filter="month" onclick="filterSales('month')">Month</button>
                <button class="sales-filter-btn" data-filter="year" onclick="filterSales('year')">Year</button>
                <button class="sales-filter-btn" data-filter="today" onclick="filterSales('today')">Today's Sales</button>
                <button class="sales-filter-btn date-range-btn" onclick="openDateRangePopup()" style="display: flex; align-items: center; gap: 6px;">
                    <i class="bi bi-calendar-range"></i> <span>Custom Range</span>
                </button>
            </div>
        </div>
        
        <!-- Weekly Sales Summary -->
        <div id="weekly-sales" class="sales-summary-container" style="display: block;">
            @if (ViewBag.WeeklySales != null && ((Dictionary<string, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.WeeklySales).Any())
            {
                @foreach (var weekData in ((Dictionary<string, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.WeeklySales).OrderByDescending(x => x.Key))
                {
                    var weekStart = DateTime.Parse(weekData.Key);
                    var weekEnd = weekStart.AddDays(6);
                    <div class="sales-card">
                        <h3>Week of @weekStart.ToString("MMM dd") - @weekEnd.ToString("MMM dd, yyyy")</h3>
                        <div class="sales-stat">
                            <span class="sales-label">Orders:</span>
                            <span class="sales-value">@weekData.Value.Count</span>
                        </div>
                        <div class="sales-stat">
                            <span class="sales-label">Revenue:</span>
                            <span class="sales-value revenue">₱@weekData.Value.Revenue.ToString("N2")</span>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="lowstock-empty">No weekly sales data available.</p>
            }
        </div>

        <!-- Monthly Sales Summary -->
        <div id="monthly-sales" class="sales-summary-container" style="display: none;">
            @if (ViewBag.MonthlySales != null && ((Dictionary<string, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.MonthlySales).Any())
            {
                @foreach (var monthData in ((Dictionary<string, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.MonthlySales).OrderByDescending(x => x.Key))
                {
                    var date = DateTime.Parse(monthData.Key + "-01");
                    <div class="sales-card">
                        <h3>@date.ToString("MMMM yyyy")</h3>
                        <div class="sales-stat">
                            <span class="sales-label">Orders:</span>
                            <span class="sales-value">@monthData.Value.Count</span>
                        </div>
                        <div class="sales-stat">
                            <span class="sales-label">Revenue:</span>
                            <span class="sales-value revenue">₱@monthData.Value.Revenue.ToString("N2")</span>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Yearly Sales Summary -->
        <div id="yearly-sales" class="sales-summary-container" style="display: none;">
            @if (ViewBag.YearlySales != null && ((Dictionary<int, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.YearlySales).Any())
            {
                @foreach (var yearData in ((Dictionary<int, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.YearlySales).OrderByDescending(x => x.Key))
                {
                    <div class="sales-card">
                        <h3>@yearData.Key</h3>
                        <div class="sales-stat">
                            <span class="sales-label">Orders:</span>
                            <span class="sales-value">@yearData.Value.Count</span>
                        </div>
                        <div class="sales-stat">
                            <span class="sales-label">Revenue:</span>
                            <span class="sales-value revenue">₱@yearData.Value.Revenue.ToString("N2")</span>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Today's Sales Detail -->
        <div id="today-sales" class="sales-summary-container" style="display: none;">
            <div class="sales-card highlight-card">
                <h3>Today (@DateTime.UtcNow.ToLocalTime().ToString("MMM dd, yyyy"))</h3>
                <div class="sales-stat">
                    <span class="sales-label">Orders:</span>
                    <span class="sales-value">@ViewBag.TodaysSales</span>
                </div>
                <div class="sales-stat">
                    <span class="sales-label">Revenue:</span>
                    <span class="sales-value revenue" style="font-size: 1.3em;">₱@todayRevenue.ToString("N2")</span>
                </div>
                <div class="sales-stat">
                    <span class="sales-label">Ala Carte:</span>
                    <span class="sales-value">₱@todayRevenueAlaCarte.ToString("N2")</span>
                </div>
                <div class="sales-stat">
                    <span class="sales-label">Unlimited:</span>
                    <span class="sales-value">₱@todayRevenueUnlimited.ToString("N2")</span>
                </div>
                <div class="sales-stat">
                    <span class="sales-label">Dine In:</span>
                    <span class="sales-value" style="color: #3498db;">₱@todayRevenueDineIn.ToString("N2")</span>
                </div>
                <div class="sales-stat">
                    <span class="sales-label">Take Out:</span>
                    <span class="sales-value" style="color: #e74c3c;">₱@todayRevenueTakeOut.ToString("N2")</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Popup Modal -->
    <div id="dateRangeModal" class="date-range-modal" aria-hidden="true">
        <div class="date-range-modal-content">
            <div class="date-range-modal-header">
                <h3><i class="bi bi-calendar-range"></i> Custom Date Range</h3>
                <button type="button" class="date-range-close" aria-label="Close date range" onclick="closeDateRangePopup()">&times;</button>
            </div>
            <form method="get" class="date-range-form" onsubmit="closeDateRangePopup()">
                <div class="date-range-fields">
                    <label>
                        From
                        <input type="date" name="startDate" value="@rangeStart.ToString("yyyy-MM-dd")" required />
                    </label>
                    <label>
                        To
                        <input type="date" name="endDate" value="@rangeEnd.ToString("yyyy-MM-dd")" required />
                    </label>
                </div>
                <div class="date-range-summary">
                    <div class="range-title">Revenue (@rangeStart.ToString("MMM dd, yyyy") - @rangeEnd.ToString("MMM dd, yyyy"))</div>
                    <div class="range-total">Total: ₱@rangeRevenue.ToString("N2")</div>
                    <div class="range-breakdown">
                        <span class="pill warning">Ala Carte: ₱@rangeRevenueAlaCarte.ToString("N2")</span>
                        <span class="pill muted">Unlimited: ₱@rangeRevenueUnlimited.ToString("N2")</span>
                        <span class="pill" style="background: #D1ECF1; color: #0C5460; border: 1px solid #BEE5EB;">Dine In: ₱@rangeRevenueDineIn.ToString("N2")</span>
                        <span class="pill" style="background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB;">Take Out: ₱@rangeRevenueTakeOut.ToString("N2")</span>
                        <span class="pill info">Orders: @rangeOrderCount</span>
                    </div>
                </div>
                <div class="date-range-actions">
                    <button type="button" class="btn-cancel" onclick="closeDateRangePopup()">Cancel</button>
                    <button type="submit" class="range-filter-apply">Apply</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chart -->
    <div class="chart-container">
        <canvas id="statsChart"></canvas>
    </div>

    <!-- Best Sellers Modal -->
    <div id="bestSellersModal" class="lowstock-modal" aria-hidden="true">
        <div class="lowstock-modal-content">
            <div class="lowstock-modal-header">
                <h3><i class="bi bi-trophy"></i> Best Sellers</h3>
                <button type="button" class="lowstock-close" aria-label="Close best sellers" onclick="hideBestSellersModal()">&times;</button>
            </div>
            <div class="lowstock-modal-body">
                <div class="best-seller-filters" style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                    <button class="sales-filter-btn active" data-bs-filter="all" onclick="filterBestSellers('all')">All Time</button>
                    <button class="sales-filter-btn" data-bs-filter="today" onclick="filterBestSellers('today')">Today</button>
                </div>
                <span class="best-sellers-sub" style="display: block; text-align: center; margin-bottom: 15px;">Top 5 by quantity</span>

                <div id="best-sellers-all" class="best-sellers-list" style="display: flex; flex-direction: column;">
                    @if (bestSellersAll.Any())
                    {
                        @foreach (var item in bestSellersAll)
                        {
                            <div class="best-seller-row">
                                <div class="best-seller-name">@item.ItemName</div>
                                <div class="best-seller-meta">
                                    <span class="pill warning">Sold: @item.Quantity</span>
                                    <span class="pill muted">₱@item.Revenue.ToString("N2")</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="lowstock-empty">No sales yet to rank best sellers.</p>
                    }
                </div>

                <div id="best-sellers-today" class="best-sellers-list" style="display: none; flex-direction: column;">
                    @if (bestSellersToday.Any())
                    {
                        @foreach (var item in bestSellersToday)
                        {
                            <div class="best-seller-row">
                                <div class="best-seller-name">@item.ItemName</div>
                                <div class="best-seller-meta">
                                    <span class="pill warning">Sold: @item.Quantity</span>
                                    <span class="pill muted">₱@item.Revenue.ToString("N2")</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="lowstock-empty">No sales today yet to rank best sellers.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Low Stock Modal -->
    <div id="lowStockModal" class="lowstock-modal" aria-hidden="true">
        <div class="lowstock-modal-content">
            <div class="lowstock-modal-header">
                <h3>Low Stock Items (@ViewBag.LowStockItems)</h3>
                <button type="button" class="lowstock-close" aria-label="Close low stock list" onclick="hideLowStockModal()">&times;</button>
            </div>
            <div class="lowstock-modal-body">
                @if (lowStockItemsList.Any())
                {
                    <div class="lowstock-list">
                        @foreach (var item in lowStockItemsList)
                        {
                            <div class="lowstock-row">
                                <div class="lowstock-name">@item.Item</div>
                                <div class="lowstock-meta">
                                    <span class="pill warning">Stock: @item.CurrentStock</span>
                                    <span class="pill muted">Reorder at @item.ReorderLevel</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="lowstock-empty">Great! No items are currently low on stock.</p>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('statsChart');

        // Revenue Chart Data
        const revenueLabels = ['Today', 'This Week', 'This Month', 'This Year'];
        const revenueData = [
            @todayRevenue,
            @(ViewBag.WeeklyRevenue ?? 0m),
            @(ViewBag.MonthlyRevenue ?? 0m),
            @(ViewBag.YearlyRevenue ?? 0m)
        ];

        const statsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Revenue (₱)',
                    data: revenueData,
                    backgroundColor: [
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(230, 126, 34, 0.7)'
                    ],
                    borderColor: [
                        'rgba(46, 204, 113, 1)',
                        'rgba(52, 152, 219, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(230, 126, 34, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { 
                            color: '#333',
                            callback: function(value) {
                                return '₱' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        ticks: { color: '#333' },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#fff',
                        borderColor: '#ccc',
                        borderWidth: 1,
                        titleColor: '#333',
                        bodyColor: '#333',
                        callbacks: {
                            label: function(context) {
                                return 'Revenue: ₱' + context.parsed.x.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            }
                        }
                    }
                }
            }
        });

        const lowStockModal = document.getElementById('lowStockModal');

        function showLowStockModal() {
            if (!lowStockModal) return;
            lowStockModal.classList.add('open');
            lowStockModal.setAttribute('aria-hidden', 'false');
        }

        function hideLowStockModal() {
            if (!lowStockModal) return;
            lowStockModal.classList.remove('open');
            lowStockModal.setAttribute('aria-hidden', 'true');
        }

        if (lowStockModal) {
            lowStockModal.addEventListener('click', (event) => {
                if (event.target === lowStockModal) {
                    hideLowStockModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && lowStockModal.classList.contains('open')) {
                    hideLowStockModal();
                }
            });
        }

        function filterBestSellers(filterType) {
            const allList = document.getElementById('best-sellers-all');
            const todayList = document.getElementById('best-sellers-today');
            const buttons = document.querySelectorAll('.best-seller-filters .sales-filter-btn');

            if (filterType === 'today') {
                allList.style.display = 'none';
                todayList.style.display = 'flex';
            } else {
                allList.style.display = 'flex';
                todayList.style.display = 'none';
            }

            buttons.forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.best-seller-filters .sales-filter-btn[data-bs-filter="${filterType}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        function filterSales(filterType) {
            // Hide all sales containers
            const weeklySales = document.getElementById('weekly-sales');
            const monthlySales = document.getElementById('monthly-sales');
            const yearlySales = document.getElementById('yearly-sales');
            const todaySales = document.getElementById('today-sales');
            
            if (weeklySales) weeklySales.style.display = 'none';
            if (monthlySales) monthlySales.style.display = 'none';
            if (yearlySales) yearlySales.style.display = 'none';
            if (todaySales) todaySales.style.display = 'none';

            // Remove active class from all buttons
            document.querySelectorAll('.sales-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected container and activate button
            if (filterType === 'week') {
                if (weeklySales) weeklySales.style.display = 'grid';
            } else if (filterType === 'month') {
                if (monthlySales) monthlySales.style.display = 'grid';
            } else if (filterType === 'year') {
                if (yearlySales) yearlySales.style.display = 'grid';
            } else if (filterType === 'today') {
                if (todaySales) todaySales.style.display = 'grid';
            }

            // Add active class to clicked button
            const activeBtn = document.querySelector(`[data-filter="${filterType}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // Best Sellers Modal Functions
        const bestSellersModal = document.getElementById('bestSellersModal');

        function showBestSellersModal() {
            if (!bestSellersModal) return;
            bestSellersModal.classList.add('open');
            bestSellersModal.setAttribute('aria-hidden', 'false');
        }

        function hideBestSellersModal() {
            if (!bestSellersModal) return;
            bestSellersModal.classList.remove('open');
            bestSellersModal.setAttribute('aria-hidden', 'true');
        }

        if (bestSellersModal) {
            bestSellersModal.addEventListener('click', (event) => {
                if (event.target === bestSellersModal) {
                    hideBestSellersModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && bestSellersModal.classList.contains('open')) {
                    hideBestSellersModal();
                }
            });
        }

        // Date Range Popup Functions
        const dateRangeModal = document.getElementById('dateRangeModal');

        function openDateRangePopup() {
            if (!dateRangeModal) return;
            dateRangeModal.classList.add('open');
            dateRangeModal.setAttribute('aria-hidden', 'false');
        }

        function closeDateRangePopup() {
            if (!dateRangeModal) return;
            dateRangeModal.classList.remove('open');
            dateRangeModal.setAttribute('aria-hidden', 'true');
        }

        if (dateRangeModal) {
            dateRangeModal.addEventListener('click', (event) => {
                if (event.target === dateRangeModal) {
                    closeDateRangePopup();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && dateRangeModal.classList.contains('open')) {
                    closeDateRangePopup();
                }
            });
        }
    </script>
}

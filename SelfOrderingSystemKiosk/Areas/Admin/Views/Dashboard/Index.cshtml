@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    var labelsJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.Labels);
    var valuesJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.Values);
    var todayRevenue = ViewBag.TodaysRevenue != null ? (decimal)ViewBag.TodaysRevenue : 0m;
    var lowStockItemsList = ViewBag.LowStockList as List<SelfOrderingSystemKiosk.Models.InventoryItem> ?? new List<SelfOrderingSystemKiosk.Models.InventoryItem>();
    var bestSellersAll = ViewBag.BestSellersAllTime as List<SelfOrderingSystemKiosk.Controllers.BestSeller> ?? new List<SelfOrderingSystemKiosk.Controllers.BestSeller>();
    var bestSellersToday = ViewBag.BestSellersToday as List<SelfOrderingSystemKiosk.Controllers.BestSeller> ?? new List<SelfOrderingSystemKiosk.Controllers.BestSeller>();
    var todayRevenueAlaCarte = ViewBag.TodaysRevenueAlaCarte != null ? (decimal)ViewBag.TodaysRevenueAlaCarte : 0m;
    var todayRevenueUnlimited = ViewBag.TodaysRevenueUnlimited != null ? (decimal)ViewBag.TodaysRevenueUnlimited : 0m;
    var rangeStart = ViewBag.RangeStart != null ? ((DateTime)ViewBag.RangeStart).ToLocalTime() : DateTime.UtcNow.ToLocalTime().Date;
    var rangeEnd = ViewBag.RangeEnd != null ? ((DateTime)ViewBag.RangeEnd).ToLocalTime() : DateTime.UtcNow.ToLocalTime().Date;
    var rangeRevenue = ViewBag.RangeRevenue != null ? (decimal)ViewBag.RangeRevenue : 0m;
    var rangeRevenueAlaCarte = ViewBag.RangeRevenueAlaCarte != null ? (decimal)ViewBag.RangeRevenueAlaCarte : 0m;
    var rangeRevenueUnlimited = ViewBag.RangeRevenueUnlimited != null ? (decimal)ViewBag.RangeRevenueUnlimited : 0m;
    var rangeOrderCount = ViewBag.RangeOrderCount != null ? (int)ViewBag.RangeOrderCount : 0;
}

<div class="dashboard-container">
    <h1>Admin Dashboard</h1>
    <p>Overview of key statistics</p>

    <!-- Stat Cards -->
    <div class="dashboard-cards">
        <div class="stat-card">
            <h3>Menu Items</h3>
            <div class="stat-value">@ViewBag.TotalMenuItems</div>
        </div>
        <div class="stat-card">
            <h3>Inventory Items</h3>
            <div class="stat-value">@ViewBag.TotalInventoryItems</div>
        </div>
        <div class="stat-card highlight-card clickable-card" role="button" tabindex="0" onclick="showLowStockModal()" onkeypress="if(event.key === 'Enter' || event.key === ' ') { showLowStockModal(); }">
            <h3>Low Stock Items</h3>
            <div class="stat-value">@ViewBag.LowStockItems</div>
        </div>
        <div class="stat-card">
            <h3>Today's Sales</h3>
            <div class="stat-value">@ViewBag.TodaysSales</div>
            <div class="stat-revenue" style="color: #27ae60; font-size: 0.9em; margin-top: 5px; font-weight: 600;">
                Total Revenue: ₱@todayRevenue.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #e67e22; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Ala Carte: ₱@todayRevenueAlaCarte.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #9b59b6; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Unlimited: ₱@todayRevenueUnlimited.ToString("N2")
            </div>
        </div>
    </div>

    <!-- Sales Summary with Filters -->
    <div class="sales-summary-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px; margin-bottom: 20px;">
            <h2 style="color: #e67e22; margin: 0;">📊 Sales Summary</h2>
            <div class="sales-filter-buttons">
                <button class="sales-filter-btn active" data-filter="day" onclick="filterSales('day')">Day</button>
                <button class="sales-filter-btn" data-filter="month" onclick="filterSales('month')">Month</button>
                <button class="sales-filter-btn" data-filter="year" onclick="filterSales('year')">Year</button>
                <button class="sales-filter-btn" data-filter="today" onclick="filterSales('today')">Today's Sales</button>
            </div>
        </div>
        
        <!-- Daily Sales Summary -->
        <div id="daily-sales" class="sales-summary-container" style="display: none;">
            @if (ViewBag.DailySales != null && ((Dictionary<string, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.DailySales).Any())
            {
                @foreach (var dayData in ((Dictionary<string, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.DailySales).OrderByDescending(x => x.Key))
                {
                    var date = DateTime.Parse(dayData.Key);
                    <div class="sales-card">
                        <h3>@date.ToString("MMM dd, yyyy")</h3>
                        <div class="sales-stat">
                            <span class="sales-label">Orders:</span>
                            <span class="sales-value">@dayData.Value.Count</span>
                        </div>
                        <div class="sales-stat">
                            <span class="sales-label">Revenue:</span>
                            <span class="sales-value revenue">₱@dayData.Value.Revenue.ToString("N2")</span>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Monthly Sales Summary -->
        <div id="monthly-sales" class="sales-summary-container" style="display: none;">
            @if (ViewBag.MonthlySales != null && ((Dictionary<string, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.MonthlySales).Any())
            {
                @foreach (var monthData in ((Dictionary<string, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.MonthlySales).OrderByDescending(x => x.Key))
                {
                    var date = DateTime.Parse(monthData.Key + "-01");
                    <div class="sales-card">
                        <h3>@date.ToString("MMMM yyyy")</h3>
                        <div class="sales-stat">
                            <span class="sales-label">Orders:</span>
                            <span class="sales-value">@monthData.Value.Count</span>
                        </div>
                        <div class="sales-stat">
                            <span class="sales-label">Revenue:</span>
                            <span class="sales-value revenue">₱@monthData.Value.Revenue.ToString("N2")</span>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Yearly Sales Summary -->
        <div id="yearly-sales" class="sales-summary-container" style="display: block;">
            @if (ViewBag.YearlySales != null && ((Dictionary<int, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.YearlySales).Any())
            {
                @foreach (var yearData in ((Dictionary<int, SelfOrderingSystemKiosk.Controllers.SalesData>)ViewBag.YearlySales).OrderByDescending(x => x.Key))
                {
                    <div class="sales-card">
                        <h3>@yearData.Key</h3>
                        <div class="sales-stat">
                            <span class="sales-label">Orders:</span>
                            <span class="sales-value">@yearData.Value.Count</span>
                        </div>
                        <div class="sales-stat">
                            <span class="sales-label">Revenue:</span>
                            <span class="sales-value revenue">₱@yearData.Value.Revenue.ToString("N2")</span>
                        </div>
                    </div>
                }
            }
        </div>

        <!-- Today's Sales Detail -->
        <div id="today-sales" class="sales-summary-container" style="display: none;">
            <div class="sales-card highlight-card">
                <h3>Today (@DateTime.UtcNow.ToLocalTime().ToString("MMM dd, yyyy"))</h3>
                <div class="sales-stat">
                    <span class="sales-label">Orders:</span>
                    <span class="sales-value">@ViewBag.TodaysSales</span>
                </div>
                <div class="sales-stat">
                    <span class="sales-label">Revenue:</span>
                    <span class="sales-value revenue" style="font-size: 1.3em;">₱@todayRevenue.ToString("N2")</span>
                </div>
                <div class="sales-stat">
                    <span class="sales-label">Ala Carte:</span>
                    <span class="sales-value">₱@todayRevenueAlaCarte.ToString("N2")</span>
                </div>
                <div class="sales-stat">
                    <span class="sales-label">Unlimited:</span>
                    <span class="sales-value">₱@todayRevenueUnlimited.ToString("N2")</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Time Range Filter -->
    <div class="range-filter">
        <form method="get" class="range-filter-form">
            <div class="range-filter-fields">
                <label>
                    From
                    <input type="date" name="startDate" value="@rangeStart.ToString("yyyy-MM-dd")" />
                </label>
                <label>
                    To
                    <input type="date" name="endDate" value="@rangeEnd.ToString("yyyy-MM-dd")" />
                </label>
            </div>
            <button type="submit" class="range-filter-apply">Apply</button>
        </form>
        <div class="range-summary">
            <div>
                <div class="range-title">Revenue (@rangeStart.ToString("MMM dd, yyyy") - @rangeEnd.ToString("MMM dd, yyyy"))</div>
                <div class="range-total">Total: ₱@rangeRevenue.ToString("N2")</div>
            </div>
            <div class="range-breakdown">
                <span class="pill warning">Ala Carte: ₱@rangeRevenueAlaCarte.ToString("N2")</span>
                <span class="pill muted">Unlimited: ₱@rangeRevenueUnlimited.ToString("N2")</span>
                <span class="pill info">Orders: @rangeOrderCount</span>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="chart-container">
        <canvas id="statsChart"></canvas>
    </div>

    <!-- Best Sellers -->
    <div class="best-sellers">
        <div class="best-sellers-header">
            <h2>🏆 Best Sellers</h2>
            <div class="sales-filter-buttons best-seller-filters">
                <button class="sales-filter-btn active" data-bs-filter="all" onclick="filterBestSellers('all')">All Time</button>
                <button class="sales-filter-btn" data-bs-filter="today" onclick="filterBestSellers('today')">Today</button>
            </div>
        </div>
        <span class="best-sellers-sub">Top 5 by quantity</span>

        <div id="best-sellers-all" class="best-sellers-list" style="display: flex;">
            @if (bestSellersAll.Any())
            {
                @foreach (var item in bestSellersAll)
                {
                    <div class="best-seller-row">
                        <div class="best-seller-name">@item.ItemName</div>
                        <div class="best-seller-meta">
                            <span class="pill warning">Sold: @item.Quantity</span>
                            <span class="pill muted">₱@item.Revenue.ToString("N2")</span>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="lowstock-empty">No sales yet to rank best sellers.</p>
            }
        </div>

        <div id="best-sellers-today" class="best-sellers-list" style="display: none;">
            @if (bestSellersToday.Any())
            {
                @foreach (var item in bestSellersToday)
                {
                    <div class="best-seller-row">
                        <div class="best-seller-name">@item.ItemName</div>
                        <div class="best-seller-meta">
                            <span class="pill warning">Sold: @item.Quantity</span>
                            <span class="pill muted">₱@item.Revenue.ToString("N2")</span>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="lowstock-empty">No sales today yet to rank best sellers.</p>
            }
        </div>
    </div>

    <!-- Low Stock Modal -->
    <div id="lowStockModal" class="lowstock-modal" aria-hidden="true">
        <div class="lowstock-modal-content">
            <div class="lowstock-modal-header">
                <h3>Low Stock Items (@ViewBag.LowStockItems)</h3>
                <button type="button" class="lowstock-close" aria-label="Close low stock list" onclick="hideLowStockModal()">&times;</button>
            </div>
            <div class="lowstock-modal-body">
                @if (lowStockItemsList.Any())
                {
                    <div class="lowstock-list">
                        @foreach (var item in lowStockItemsList)
                        {
                            <div class="lowstock-row">
                                <div class="lowstock-name">@item.Item</div>
                                <div class="lowstock-meta">
                                    <span class="pill warning">Stock: @item.CurrentStock</span>
                                    <span class="pill muted">Reorder at @item.ReorderLevel</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="lowstock-empty">Great! No items are currently low on stock.</p>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('statsChart');

        const statsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(labelsJson),
                datasets: [{
                    label: 'Statistics',
                    data: @Html.Raw(valuesJson),
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { color: '#333' },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        ticks: { color: '#333' },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#fff',
                        borderColor: '#ccc',
                        borderWidth: 1,
                        titleColor: '#333',
                        bodyColor: '#333'
                    }
                },
                onClick: (event, elements, chart) => {
                    if (!elements.length) return;
                    const barIndex = elements[0].index;
                    const label = chart.data.labels[barIndex];
                    if (label === 'Low Stock') {
                        showLowStockModal();
                    }
                }
            }
        });

        const lowStockModal = document.getElementById('lowStockModal');

        function showLowStockModal() {
            if (!lowStockModal) return;
            lowStockModal.classList.add('open');
            lowStockModal.setAttribute('aria-hidden', 'false');
        }

        function hideLowStockModal() {
            if (!lowStockModal) return;
            lowStockModal.classList.remove('open');
            lowStockModal.setAttribute('aria-hidden', 'true');
        }

        if (lowStockModal) {
            lowStockModal.addEventListener('click', (event) => {
                if (event.target === lowStockModal) {
                    hideLowStockModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && lowStockModal.classList.contains('open')) {
                    hideLowStockModal();
                }
            });
        }

        function filterBestSellers(filterType) {
            const allList = document.getElementById('best-sellers-all');
            const todayList = document.getElementById('best-sellers-today');
            const buttons = document.querySelectorAll('.best-seller-filters .sales-filter-btn');

            if (filterType === 'today') {
                allList.style.display = 'none';
                todayList.style.display = 'flex';
            } else {
                allList.style.display = 'flex';
                todayList.style.display = 'none';
            }

            buttons.forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.best-seller-filters .sales-filter-btn[data-bs-filter="${filterType}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        function filterSales(filterType) {
            // Hide all sales containers
            document.getElementById('daily-sales').style.display = 'none';
            document.getElementById('monthly-sales').style.display = 'none';
            document.getElementById('yearly-sales').style.display = 'none';
            document.getElementById('today-sales').style.display = 'none';

            // Remove active class from all buttons
            document.querySelectorAll('.sales-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected container and activate button
            if (filterType === 'day') {
                document.getElementById('daily-sales').style.display = 'grid';
            } else if (filterType === 'month') {
                document.getElementById('monthly-sales').style.display = 'grid';
            } else if (filterType === 'year') {
                document.getElementById('yearly-sales').style.display = 'grid';
            } else if (filterType === 'today') {
                document.getElementById('today-sales').style.display = 'grid';
            }

            // Add active class to clicked button
            document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');
        }
    </script>
}

@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    var todayRevenue = ViewBag.TodaysRevenue != null ? (decimal)ViewBag.TodaysRevenue : 0m;
    var todayRevenueDineIn = ViewBag.TodaysRevenueDineIn != null ? (decimal)ViewBag.TodaysRevenueDineIn : 0m;
    var todayRevenueTakeOut = ViewBag.TodaysRevenueTakeOut != null ? (decimal)ViewBag.TodaysRevenueTakeOut : 0m;
    var lowStockItemsList = ViewBag.LowStockList as List<SelfOrderingSystemKiosk.Models.InventoryItem> ?? new List<SelfOrderingSystemKiosk.Models.InventoryItem>();
    var bestSellersAll = ViewBag.BestSellersAllTime as List<SelfOrderingSystemKiosk.Controllers.BestSeller> ?? new List<SelfOrderingSystemKiosk.Controllers.BestSeller>();
    var bestSellersToday = ViewBag.BestSellersToday as List<SelfOrderingSystemKiosk.Controllers.BestSeller> ?? new List<SelfOrderingSystemKiosk.Controllers.BestSeller>();
    var bestSellersMonthly = ViewBag.BestSellersMonthly as List<SelfOrderingSystemKiosk.Controllers.BestSeller> ?? new List<SelfOrderingSystemKiosk.Controllers.BestSeller>();
    var todayRevenueAlaCarte = ViewBag.TodaysRevenueAlaCarte != null ? (decimal)ViewBag.TodaysRevenueAlaCarte : 0m;
    var todayRevenueUnlimited = ViewBag.TodaysRevenueUnlimited != null ? (decimal)ViewBag.TodaysRevenueUnlimited : 0m;
    var rangeStart = ViewBag.RangeStart != null ? ((DateTime)ViewBag.RangeStart).ToLocalTime() : DateTime.UtcNow.ToLocalTime().Date;
    var rangeEnd = ViewBag.RangeEnd != null ? ((DateTime)ViewBag.RangeEnd).ToLocalTime() : DateTime.UtcNow.ToLocalTime().Date;
    var rangeRevenue = ViewBag.RangeRevenue != null ? (decimal)ViewBag.RangeRevenue : 0m;
    var rangeRevenueAlaCarte = ViewBag.RangeRevenueAlaCarte != null ? (decimal)ViewBag.RangeRevenueAlaCarte : 0m;
    var rangeRevenueUnlimited = ViewBag.RangeRevenueUnlimited != null ? (decimal)ViewBag.RangeRevenueUnlimited : 0m;
    var rangeRevenueDineIn = ViewBag.RangeRevenueDineIn != null ? (decimal)ViewBag.RangeRevenueDineIn : 0m;
    var rangeRevenueTakeOut = ViewBag.RangeRevenueTakeOut != null ? (decimal)ViewBag.RangeRevenueTakeOut : 0m;
    var rangeOrderCount = ViewBag.RangeOrderCount != null ? (int)ViewBag.RangeOrderCount : 0;
    var chartData = ViewBag.ChartData as Dictionary<string, decimal> ?? new Dictionary<string, decimal>();
    var chartLabelsJson = System.Text.Json.JsonSerializer.Serialize(chartData.Keys.OrderBy(k => k).Select(k => DateTime.Parse(k).ToString("MMM dd")).ToList());
    var chartValuesJson = System.Text.Json.JsonSerializer.Serialize(chartData.Keys.OrderBy(k => k).Select(k => chartData[k]).ToList());
}

<div class="dashboard-container">
    <h1>Admin Dashboard</h1>
    <p>Overview of key statistics</p>

    <!-- Stat Cards -->
    <div class="dashboard-cards">
        <div class="stat-card">
            <h3>Menu Items</h3>
            <div class="stat-value">@ViewBag.TotalMenuItems</div>
        </div>
        <div class="stat-card">
            <h3>Inventory Items</h3>
            <div class="stat-value">@ViewBag.TotalInventoryItems</div>
        </div>
        <div class="stat-card highlight-card clickable-card" role="button" tabindex="0" onclick="showLowStockModal()" onkeypress="if(event.key === 'Enter' || event.key === ' ') { showLowStockModal(); }">
            <h3>Low Stock Items</h3>
            <div class="stat-value">@ViewBag.LowStockItems</div>
        </div>
        <div class="stat-card">
            <h3>Today's Sales</h3>
            <div class="stat-value">@ViewBag.TodaysSales</div>
            <div class="stat-revenue" style="color: #27ae60; font-size: 0.9em; margin-top: 5px; font-weight: 600;">
                Total Revenue: ₱@todayRevenue.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #e67e22; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Ala Carte: ₱@todayRevenueAlaCarte.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #9b59b6; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Unlimited: ₱@todayRevenueUnlimited.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #3498db; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Dine In: ₱@todayRevenueDineIn.ToString("N2")
            </div>
            <div class="stat-revenue" style="color: #e74c3c; font-size: 0.85em; margin-top: 2px; font-weight: 600;">
                Take Out: ₱@todayRevenueTakeOut.ToString("N2")
            </div>
        </div>
        <div class="stat-card highlight-card clickable-card" role="button" tabindex="0" onclick="showBestSellersModal()" onkeypress="if(event.key === 'Enter' || event.key === ' ') { showBestSellersModal(); }">
            <h3><i class="bi bi-trophy"></i> Best Sellers</h3>
            <div class="stat-value" style="font-size: 1.2em;">Top 5</div>
            <div style="color: #666; font-size: 0.85em; margin-top: 5px;">Click to view details</div>
        </div>
    </div>

    <!-- Revenue Analytics Section -->
    <div class="revenue-analytics-section" style="margin-top: 40px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #e67e22; margin: 0; display: flex; align-items: center; gap: 10px;"><i class="bi bi-graph-up"></i> <span>Revenue Analytics</span></h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                @{
                    var hasCustomRange = ViewBag.HasCustomRange != null && (bool)ViewBag.HasCustomRange;
                }
                <button class="sales-filter-btn @(!hasCustomRange ? "active" : "")" data-filter="week" onclick="filterChart('week')">This Week</button>
                <button class="sales-filter-btn @(!hasCustomRange ? "" : "")" data-filter="month" onclick="filterChart('month')">This Month</button>
                <button class="sales-filter-btn @(!hasCustomRange ? "" : "")" data-filter="year" onclick="filterChart('year')">This Year</button>
                <button class="sales-filter-btn date-range-btn @(hasCustomRange ? "active" : "")" onclick="openDateRangePopup()" style="display: flex; align-items: center; gap: 6px;">
                    <i class="bi bi-calendar-range"></i> <span>Custom Range</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Date Range Popup Modal -->
    <div id="dateRangeModal" class="date-range-modal" aria-hidden="true">
        <div class="date-range-modal-content">
            <div class="date-range-modal-header">
                <h3><i class="bi bi-calendar-range"></i> Custom Date Range</h3>
                <button type="button" class="date-range-close" aria-label="Close date range" onclick="closeDateRangePopup()">&times;</button>
            </div>
            <form method="get" class="date-range-form" onsubmit="closeDateRangePopup()">
                <div class="date-range-fields">
                    <label>
                        From
                        <input type="date" name="startDate" value="@rangeStart.ToString("yyyy-MM-dd")" required />
                    </label>
                    <label>
                        To
                        <input type="date" name="endDate" value="@rangeEnd.ToString("yyyy-MM-dd")" required />
                    </label>
                </div>
                <div class="date-range-summary">
                    <div class="range-title">Revenue (@rangeStart.ToString("MMM dd, yyyy") - @rangeEnd.ToString("MMM dd, yyyy"))</div>
                    <div class="range-total">Total: ₱@rangeRevenue.ToString("N2")</div>
                    <div class="range-breakdown">
                        <span class="pill warning">Ala Carte: ₱@rangeRevenueAlaCarte.ToString("N2")</span>
                        <span class="pill muted">Unlimited: ₱@rangeRevenueUnlimited.ToString("N2")</span>
                        <span class="pill" style="background: #D1ECF1; color: #0C5460; border: 1px solid #BEE5EB;">Dine In: ₱@rangeRevenueDineIn.ToString("N2")</span>
                        <span class="pill" style="background: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB;">Take Out: ₱@rangeRevenueTakeOut.ToString("N2")</span>
                        <span class="pill info">Orders: @rangeOrderCount</span>
                    </div>
                </div>
                <div class="date-range-actions">
                    <button type="button" class="btn-cancel" onclick="closeDateRangePopup()">Cancel</button>
                    <button type="submit" class="range-filter-apply">Apply</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Revenue Chart -->
    <div class="chart-container">
        <h3 style="text-align: center; color: #e67e22; margin-bottom: 15px; font-size: 1.1em;">
            Revenue Chart (@rangeStart.ToString("MMM dd, yyyy") - @rangeEnd.ToString("MMM dd, yyyy"))
        </h3>
        <div style="width: 100%; height: 350px; position: relative;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <!-- Best Sellers Modal -->
    <div id="bestSellersModal" class="lowstock-modal" aria-hidden="true">
        <div class="lowstock-modal-content">
            <div class="lowstock-modal-header">
                <h3><i class="bi bi-trophy"></i> Best Sellers</h3>
                <button type="button" class="lowstock-close" aria-label="Close best sellers" onclick="hideBestSellersModal()">&times;</button>
            </div>
            <div class="lowstock-modal-body">
                <div class="best-seller-filters" style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                    <button class="sales-filter-btn active" data-bs-filter="all" onclick="filterBestSellers('all')">All Time</button>
                    <button class="sales-filter-btn" data-bs-filter="month" onclick="filterBestSellers('month')">This Month</button>
                    <button class="sales-filter-btn" data-bs-filter="today" onclick="filterBestSellers('today')">Today</button>
                </div>
                <span class="best-sellers-sub" style="display: block; text-align: center; margin-bottom: 15px;">Top 5 by quantity</span>

                <div id="best-sellers-all" class="best-sellers-list" style="display: flex; flex-direction: column;">
                    @if (bestSellersAll.Any())
                    {
                        @foreach (var item in bestSellersAll)
                        {
                            <div class="best-seller-row">
                                <div class="best-seller-name">@item.ItemName</div>
                                <div class="best-seller-meta">
                                    <span class="pill warning">Sold: @item.Quantity</span>
                                    <span class="pill muted">₱@item.Revenue.ToString("N2")</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="lowstock-empty">No sales yet to rank best sellers.</p>
                    }
                </div>

                <div id="best-sellers-month" class="best-sellers-list" style="display: none; flex-direction: column;">
                    @if (bestSellersMonthly.Any())
                    {
                        @foreach (var item in bestSellersMonthly)
                        {
                            <div class="best-seller-row">
                                <div class="best-seller-name">@item.ItemName</div>
                                <div class="best-seller-meta">
                                    <span class="pill warning">Sold: @item.Quantity</span>
                                    <span class="pill muted">₱@item.Revenue.ToString("N2")</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="lowstock-empty">No sales this month yet to rank best sellers.</p>
                    }
                </div>

                <div id="best-sellers-today" class="best-sellers-list" style="display: none; flex-direction: column;">
                    @if (bestSellersToday.Any())
                    {
                        @foreach (var item in bestSellersToday)
                        {
                            <div class="best-seller-row">
                                <div class="best-seller-name">@item.ItemName</div>
                                <div class="best-seller-meta">
                                    <span class="pill warning">Sold: @item.Quantity</span>
                                    <span class="pill muted">₱@item.Revenue.ToString("N2")</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="lowstock-empty">No sales today yet to rank best sellers.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Low Stock Modal -->
    <div id="lowStockModal" class="lowstock-modal" aria-hidden="true">
        <div class="lowstock-modal-content">
            <div class="lowstock-modal-header">
                <h3>Low Stock Items (@ViewBag.LowStockItems)</h3>
                <button type="button" class="lowstock-close" aria-label="Close low stock list" onclick="hideLowStockModal()">&times;</button>
            </div>
            <div class="lowstock-modal-body">
                @if (lowStockItemsList.Any())
                {
                    <div class="lowstock-list">
                        @foreach (var item in lowStockItemsList)
                        {
                            <div class="lowstock-row">
                                <div class="lowstock-name">@item.Item</div>
                                <div class="lowstock-meta">
                                    <span class="pill warning">Stock: @item.CurrentStock</span>
                                    <span class="pill muted">Reorder at @item.ReorderLevel</span>
                                </div>
                                <div class="lowstock-actions" style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
                                    <input type="number" id="restock-qty-@item.Id" min="1" value="10" style="width: 80px; padding: 6px; border: 1px solid #f0d7bf; border-radius: 6px; font-size: 0.9em;" />
                                    <button class="btn-restock" onclick="restockItem('@item.Id', '@item.Item')" style="padding: 6px 12px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: 600;">Restock</button>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="lowstock-empty">Great! No items are currently low on stock.</p>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('revenueChart');
        let revenueChart;

        // Initialize chart with current data
        const chartLabels = @Html.Raw(chartLabelsJson);
        const chartValues = @Html.Raw(chartValuesJson);

        function initChart(labels, values) {
            if (revenueChart) {
                revenueChart.destroy();
            }

            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue (₱)',
                        data: values,
                        backgroundColor: 'rgba(230, 126, 34, 0.7)',
                        borderColor: 'rgba(230, 126, 34, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#333',
                                font: {
                                    size: 11
                                },
                                maxTicksLimit: 8,
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return '₱' + (value / 1000).toFixed(1) + 'k';
                                    }
                                    return '₱' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                }
                            },
                            grid: { 
                                color: 'rgba(0,0,0,0.05)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: { 
                                color: '#333',
                                font: {
                                    size: 10
                                },
                                maxRotation: 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            },
                            grid: { 
                                color: 'rgba(0,0,0,0.05)',
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#fff',
                            borderColor: '#ccc',
                            borderWidth: 1,
                            titleColor: '#333',
                            bodyColor: '#333',
                            titleFont: {
                                size: 12
                            },
                            bodyFont: {
                                size: 12
                            },
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    return 'Revenue: ₱' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize chart on page load
        initChart(chartLabels, chartValues);

        function filterChart(filterType) {
            // Remove active class from all buttons
            document.querySelectorAll('.sales-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to clicked button
            const activeBtn = document.querySelector(`[data-filter="${filterType}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Reload page with filter parameter
            const url = new URL(window.location.href);
            url.searchParams.delete('startDate');
            url.searchParams.delete('endDate');
            
            if (filterType !== 'today') {
                const today = new Date();
                let startDate, endDate;
                
                if (filterType === 'week') {
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
                    endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 6);
                } else if (filterType === 'month') {
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                } else if (filterType === 'year') {
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                }
                
                if (startDate && endDate) {
                    url.searchParams.set('startDate', startDate.toISOString().split('T')[0]);
                    url.searchParams.set('endDate', endDate.toISOString().split('T')[0]);
                }
            }
            
            window.location.href = url.toString();
        }

        const lowStockModal = document.getElementById('lowStockModal');

        function showLowStockModal() {
            if (!lowStockModal) return;
            lowStockModal.classList.add('open');
            lowStockModal.setAttribute('aria-hidden', 'false');
        }

        function hideLowStockModal() {
            if (!lowStockModal) return;
            lowStockModal.classList.remove('open');
            lowStockModal.setAttribute('aria-hidden', 'true');
        }

        if (lowStockModal) {
            lowStockModal.addEventListener('click', (event) => {
                if (event.target === lowStockModal) {
                    hideLowStockModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && lowStockModal.classList.contains('open')) {
                    hideLowStockModal();
                }
            });
        }

        function filterBestSellers(filterType) {
            const allList = document.getElementById('best-sellers-all');
            const monthList = document.getElementById('best-sellers-month');
            const todayList = document.getElementById('best-sellers-today');
            const buttons = document.querySelectorAll('.best-seller-filters .sales-filter-btn');

            // Hide all lists
            allList.style.display = 'none';
            monthList.style.display = 'none';
            todayList.style.display = 'none';

            // Show selected list
            if (filterType === 'today') {
                todayList.style.display = 'flex';
            } else if (filterType === 'month') {
                monthList.style.display = 'flex';
            } else {
                allList.style.display = 'flex';
            }

            buttons.forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.best-seller-filters .sales-filter-btn[data-bs-filter="${filterType}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        async function restockItem(itemId, itemName) {
            const quantityInput = document.getElementById('restock-qty-' + itemId);
            const quantity = parseInt(quantityInput.value);

            if (!quantity || quantity <= 0) {
                alert('Please enter a valid quantity greater than 0.');
                return;
            }

            if (!confirm(`Restock ${itemName} by ${quantity} units?`)) {
                return;
            }

            try {
                const response = await fetch('@Url.Action("RestockItem", "Dashboard")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `id=${encodeURIComponent(itemId)}&quantity=${quantity}`
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    // Reload the page to refresh the low stock list
                    window.location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error restocking item: ' + error.message);
            }
        }


        // Best Sellers Modal Functions
        const bestSellersModal = document.getElementById('bestSellersModal');

        function showBestSellersModal() {
            if (!bestSellersModal) return;
            bestSellersModal.classList.add('open');
            bestSellersModal.setAttribute('aria-hidden', 'false');
        }

        function hideBestSellersModal() {
            if (!bestSellersModal) return;
            bestSellersModal.classList.remove('open');
            bestSellersModal.setAttribute('aria-hidden', 'true');
        }

        if (bestSellersModal) {
            bestSellersModal.addEventListener('click', (event) => {
                if (event.target === bestSellersModal) {
                    hideBestSellersModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && bestSellersModal.classList.contains('open')) {
                    hideBestSellersModal();
                }
            });
        }

        // Date Range Popup Functions
        const dateRangeModal = document.getElementById('dateRangeModal');

        function openDateRangePopup() {
            if (!dateRangeModal) return;
            dateRangeModal.classList.add('open');
            dateRangeModal.setAttribute('aria-hidden', 'false');
        }

        function closeDateRangePopup() {
            if (!dateRangeModal) return;
            dateRangeModal.classList.remove('open');
            dateRangeModal.setAttribute('aria-hidden', 'true');
        }

        if (dateRangeModal) {
            dateRangeModal.addEventListener('click', (event) => {
                if (event.target === dateRangeModal) {
                    closeDateRangePopup();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && dateRangeModal.classList.contains('open')) {
                    closeDateRangePopup();
                }
            });
        }
    </script>
}

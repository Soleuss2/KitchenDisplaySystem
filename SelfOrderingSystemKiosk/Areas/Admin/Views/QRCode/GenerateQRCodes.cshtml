@{
    ViewData["Title"] = "Generate QR Codes for Tables";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="content fade-in">
    <div class="header">
        <h1>ðŸ“± Generate QR Codes for Tables</h1>
        <p>Generate and print QR codes for each table to enable easy reordering.</p>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-top: 30px;">
        @for (int tableNum = 1; tableNum <= 4; tableNum++)
        {
            <div style="background: white; border: 2px solid #f0d7bf; border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h2 style="color: #d35400; margin-bottom: 15px;">
                    <i class="bi bi-table"></i> Table @tableNum
                </h2>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">
                    Click to view and print QR code
                </p>
                <button onclick="showQRCode(@tableNum)" class="btn btn-edit qr-show-btn" style="width: 100%; padding: 12px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="bi bi-qr-code"></i> <span>Show QR Code</span>
                </button>
            </div>
        }
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="qr-modal" aria-hidden="true">
        <div class="qr-modal-content">
            <div class="qr-modal-header">
                <h3 id="qrModalTitle">Table QR Code</h3>
                <button type="button" class="qr-modal-close" aria-label="Close QR code" onclick="closeQRModal()">&times;</button>
            </div>
            <div class="qr-modal-body">
                <div id="qr-code-container" style="text-align: center; padding: 20px;">
                    <div style="color: #999; font-size: 0.9em;">Generating QR code...</div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="printCurrentQRCode()" class="btn btn-edit qr-print-btn" style="padding: 12px 25px; font-size: 1rem; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="bi bi-printer"></i> <span>Print QR Code</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 40px; padding: 20px; background: #fff3e6; border-radius: 10px; border-left: 4px solid #e67e22;">
        <h3 style="color: #d35400; margin-bottom: 10px;"><i class="bi bi-info-circle"></i> Instructions</h3>
        <ol style="color: #666; line-height: 1.8;">
            <li>Each QR code is unique to its table number</li>
            <li>Print each QR code and place it on the corresponding table</li>
            <li>Customers can scan the QR code to access the menu and place orders</li>
            <li>The table number will be automatically associated with their order</li>
            <li>Customers can reorder anytime by scanning the QR code again</li>
        </ol>
    </div>
</div>

@{
    var baseUrl = $"{Context.Request.Scheme}://{Context.Request.Host}";
}

@section Scripts {
    <!-- Using qrcodejs - simpler and more reliable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" 
            onload="window.qrcodeLibraryReady = true; console.log('QRCode library script loaded');"
            onerror="console.error('Failed to load QRCode library from CDN');"></script>
    <script>
        let currentTableNumber = null;
        let qrCodeLibraryLoaded = false;
        const baseUrl = 'https://kitchendisplaysystem.onrender.com';
        
        // Fallback CDN loader
        function loadQRCodeFallback() {
            console.log('Primary CDN failed, trying fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js';
            script.onload = function() {
                console.log('Fallback CDN loaded successfully');
                qrCodeLibraryLoaded = true;
            };
            script.onerror = function() {
                console.error('All CDN sources failed');
                const qrContainer = document.getElementById('qr-code-container');
                if (qrContainer) {
                    qrContainer.innerHTML = '<p style="color: red; padding: 20px;">Error: Unable to load QR Code library. Please check your internet connection.</p>';
                }
            };
            document.head.appendChild(script);
        }
        
        // Table URLs
        const tableUrls = {
            @for (int tableNum = 1; tableNum <= 4; tableNum++)
            {
                var qrUrl = $"https://kitchendisplaysystem.onrender.com/Customer/Kiosk/TableMenu?tableNumber={tableNum}";
                <text>
                @tableNum: '@Html.Raw(qrUrl)',
                </text>
            }
        };

        // Check if QRCode library is loaded (supports both qrcodejs and qrcode)
        function checkQRCodeLibrary() {
            // Check for qrcodejs (simpler library) - it's a constructor function
            if (typeof QRCode !== 'undefined' && typeof QRCode === 'function') {
                qrCodeLibraryLoaded = true;
                return true;
            }
            // Check for qrcode (npm package) - has toCanvas method
            if (typeof QRCode !== 'undefined' && typeof QRCode.toCanvas === 'function') {
                qrCodeLibraryLoaded = true;
                return true;
            }
            return false;
        }

        // Wait for library to load
        function waitForQRCodeLibrary(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkInterval = setInterval(function() {
                attempts++;
                if (checkQRCodeLibrary()) {
                    clearInterval(checkInterval);
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.error('QRCode library failed to load after ' + maxAttempts + ' attempts');
                    console.log('QRCode type:', typeof QRCode);
                    const qrContainer = document.getElementById('qr-code-container');
                    if (qrContainer) {
                        qrContainer.innerHTML = '<p style="color: red; padding: 20px;">Error: QR Code library failed to load. Please refresh the page or check your internet connection.</p>';
                    }
                }
            }, 200);
        }

        function showQRCode(tableNumber) {
            currentTableNumber = tableNumber;
            const modal = document.getElementById('qrModal');
            const modalTitle = document.getElementById('qrModalTitle');
            const qrContainer = document.getElementById('qr-code-container');
            
            if (!modal || !qrContainer) return;
            
            // Update modal title
            modalTitle.textContent = 'Table ' + tableNumber + ' QR Code';
            
            // Show modal
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            
            // Clear container and show loading
            qrContainer.innerHTML = '<div style="color: #999; font-size: 0.9em; padding: 20px;"><i class="bi bi-hourglass-split"></i> Generating QR code...</div>';
            
            // Generate QR code
            const qrUrl = tableUrls[tableNumber];
            if (!qrUrl) {
                qrContainer.innerHTML = '<p style="color: red;">Error: Invalid table number</p>';
                return;
            }
            
            // Check if library is loaded, if not wait for it
            if (!checkQRCodeLibrary()) {
                waitForQRCodeLibrary(function() {
                    generateQRCode(qrContainer, qrUrl, tableNumber);
                });
            } else {
                generateQRCode(qrContainer, qrUrl, tableNumber);
            }
        }

        function generateQRCode(container, qrUrl, tableNumber) {
            // Clear container
            container.innerHTML = '';
            
            try {
                // Try qrcodejs first (simpler library)
                if (typeof QRCode !== 'undefined' && !QRCode.toCanvas) {
                    // Using qrcodejs library
                    const qrDiv = document.createElement('div');
                    container.appendChild(qrDiv);
                    new QRCode(qrDiv, {
                        text: qrUrl,
                        width: 300,
                        height: 300,
                        colorDark: '#d35400',
                        colorLight: '#ffffff',
                        correctLevel: 3 // High error correction for qrcodejs
                    });
                    console.log('QR code generated for Table ' + tableNumber + ' using qrcodejs');
                } else if (typeof QRCode !== 'undefined' && typeof QRCode.toCanvas === 'function') {
                    // Using qrcode npm package
                    const canvas = document.createElement('canvas');
                    container.appendChild(canvas);
                    QRCode.toCanvas(canvas, qrUrl, {
                        width: 300,
                        height: 300,
                        colorDark: '#d35400',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    }, function (error) {
                        if (error) {
                            console.error('Error generating QR code for Table ' + tableNumber + ':', error);
                            container.innerHTML = '<p style="color: red; padding: 20px;">Error generating QR code. Please try again.</p>';
                        } else {
                            console.log('QR code generated for Table ' + tableNumber);
                        }
                    });
                } else {
                    throw new Error('QRCode library not available');
                }
            } catch (error) {
                console.error('Exception generating QR code:', error);
                container.innerHTML = '<p style="color: red; padding: 20px;">Error: ' + error.message + '</p>';
            }
        }

        function closeQRModal() {
            const modal = document.getElementById('qrModal');
            if (modal) {
                modal.classList.remove('open');
                modal.setAttribute('aria-hidden', 'true');
            }
        }

        function printCurrentQRCode() {
            if (!currentTableNumber) return;
            
            const qrContainer = document.getElementById('qr-code-container');
            // Try to find canvas (from qrcode npm) or img (from qrcodejs)
            const qrCanvas = qrContainer.querySelector('canvas');
            const qrImg = qrContainer.querySelector('img');
            
            let imgData = null;
            if (qrCanvas) {
                imgData = qrCanvas.toDataURL('image/png');
            } else if (qrImg) {
                imgData = qrImg.src;
            } else {
                // Try to get from the div's first child
                const firstChild = qrContainer.firstElementChild;
                if (firstChild && firstChild.tagName === 'CANVAS') {
                    imgData = firstChild.toDataURL('image/png');
                } else if (firstChild && firstChild.tagName === 'IMG') {
                    imgData = firstChild.src;
                }
            }
            
            if (imgData) {
                const printWindow = window.open('', '_blank');
                const printContent = '<html>' +
                    '<head>' +
                    '<title>Table ' + currentTableNumber + ' QR Code</title>' +
                    '<style>' +
                    'body { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: Arial, sans-serif; }' +
                    'h1 { color: #d35400; margin-bottom: 20px; }' +
                    'img { border: 2px solid #d35400; padding: 10px; }' +
                    'p { margin-top: 20px; color: #666; }' +
                    '@@media print { body { margin: 0; } }' +
                    '</style>' +
                    '</head>' +
                    '<body>' +
                    '<h1>Table ' + currentTableNumber + '</h1>' +
                    '<img src="' + imgData + '" alt="QR Code for Table ' + currentTableNumber + '" />' +
                    '<p>Scan to order from Table ' + currentTableNumber + '</p>' +
                    '</body>' +
                    '</html>';
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            } else {
                alert('QR code not found. Please generate it first.');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('qrModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeQRModal();
                    }
                });
                
                // Close on ESC key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && modal.classList.contains('open')) {
                        closeQRModal();
                    }
                });
            }
            
            // Check if library loaded on page load
            // Give it a moment for the script to load
            setTimeout(function() {
                if (checkQRCodeLibrary()) {
                    console.log('QRCode library loaded successfully');
                    qrCodeLibraryLoaded = true;
                } else {
                    console.log('Waiting for QRCode library to load...');
                    waitForQRCodeLibrary(function() {
                        console.log('QRCode library loaded successfully');
                        qrCodeLibraryLoaded = true;
                    }, 50); // Increase attempts since we're checking every 150ms
                }
            }, 1000); // Give more time for CDN to load
        });
    </script>
}

